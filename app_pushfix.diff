--- app.py
+++ app_fixed2.py
@@ -3,6 +3,11 @@
 
 import streamlit as st
 st.set_page_config(
+# === [BOOTSTRAP] session keys (must be first) ===
+if "messages" not in st.session_state:
+    st.session_state.messages = []
+if "_last_user_nonce" not in st.session_state:
+    st.session_state["_last_user_nonce"] = None
     page_title="법제처 법무 상담사",
     page_icon="⚖️",
     layout="wide",
@@ -388,6 +393,26 @@
 
 
 # ✅ 중요: ‘최초 화면’ 렌더링 전에 먼저 호출
+def _push_user_from_pending() -> str | None:
+    q = st.session_state.pop("_pending_user_q", None)
+    nonce = st.session_state.pop("_pending_user_nonce", None)
+    if not q:
+        return None
+    if nonce and st.session_state.get("_last_user_nonce") == nonce:
+        return None
+
+    st.session_state.messages.append({
+        "role": "user",
+        "content": q.strip(),
+        "ts": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
+    })
+    st.session_state["_last_user_nonce"] = nonce
+
+    for k in ("_first_files", "first_files"):
+        st.session_state.pop(k, None)
+    return q
+
+
 user_q = _push_user_from_pending()
 
 
@@ -415,7 +440,6 @@
         st.rerun()
 
 # (B) pending → messages 로 옮길 때, 최초 업로더·키 정리
-def _push_user_from_pending() -> str | None:
     q = st.session_state.pop("_pending_user_q", None)
     nonce = st.session_state.pop("_pending_user_nonce", None)
     if not q: return None
@@ -2261,4 +2285,4 @@
 
 if not chat_started:
     # 1) 대화 전 — 중앙 고정 화면
-    render_pre_chat_center()
+    render_pre_chat_center()